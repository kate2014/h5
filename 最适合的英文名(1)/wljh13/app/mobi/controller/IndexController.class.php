<?phpclass IndexController extends BaseController {	function __construct() {		parent::__construct();        // print_r($_SERVER['HTTP_REFERER']);die;                //if(!(preg_match("/user/i",$_SERVER['HTTP_REFERER']))){        //$this->getWxUserInfo22();         //}       //  $v=1;       //  if(($_GET['tx']!=1)){        //  $v = $this->getWxUserInfo22();        // }       //var_dump($v);       // $this->assign('subscribe2',$v);       //	}	function checkLogin() {		if (!(isset($_SESSION["isLoginUser"]) && $_SESSION["isLoginUser"] === 1 && $_SESSION['isUser'])) {			$user_agent = $_SERVER['HTTP_USER_AGENT'];			if (false === strpos($user_agent, 'MicroMessenger')) {				//非微信要求登录				$this -> jump("?c=login");			} else {				// 微信浏览器，自动调用微信帐号信息				$this->wxLogin();			}		}	}		/**	 * 微信登录	 */	function wxLogin() {        		$website = 'http://' . $_SERVER["HTTP_HOST"];		$url = urlencode($website . '/?c=Login&act=getWxUserInfo');		$url_code = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=" . APPID . "&redirect_uri=" . $url . "&response_type=code&scope=snsapi_userinfo&state=1";		//echo $url_code;		//exit;		$this->jump($url_code);	}	function test($rss1){		echo "<pre>";		print_r($rss1);		echo "</pre>";		die();	}	function index() {        $obj_goods = new CommonModel();        $obj_goods->table='goods';        $allw_goods = $obj_goods->getOther('');        $all_goods = $obj_goods->getOther('hot!=1');        $hot_goods = $obj_goods->getOther('hot=1');        $yr_goods=$obj_goods->getOther('state=0');        $in_goods=$obj_goods->getOther('state=1');        $end_goods=$obj_goods->getOther('state=2');        $obj_f = new CommonModel();        $obj_f-> table ='fund';        $fundlist = $obj_f -> all2(' 1=1 group by goods_id ',null,0,' goods_id asc ',' goods_id,count(id) as count,sum(money) as money ');        foreach ($fundlist as $key => $value) {            $g_id = $value["goods_id"];            $fund[$g_id] = $value;        }//获取众筹数        $obj_p = new CommonModel();        $obj_p -> table = "praise";        $praiselist = $obj_p -> all2(' 1=1 group by goods_id ',null,0,' goods_id asc ',' goods_id,count(id) as praise ');        foreach ($praiselist as $key => $value) {            $g_id = $value["goods_id"];            $praise[$g_id] = $value;        }//获得点赞数        $zero1=strtotime (date("y-m-d "));         foreach ($hot_goods as $key => $value) {            $g_id = $value['id'];            $value['money'] = $fund[$g_id]['money'];            $value['count'] = $fund[$g_id]['count'];            $value['praise'] = $praise[$g_id]['praise'];            $value['percent'] = (($value['money']/$value['price'])*100).'%';            $value['zero2'] = strtotime ($hot_goods[$key]['until_time']);            $value['tianshu'] = ceil(($value['zero2']-$zero1)/86400);            $value['days'] = '';            if ($value['tianshu']>=0) {                $value['days'] = $value['tianshu'];            }else{                 $value['days'] = 0;            }            if($value['percent']>100){                $value['percent']=100;        }             $hot_goods[$key] = $value;        }//组合        //var_dump($hot_goods[$key]['days']);exit();         foreach ($all_goods as $key => $value) {            $g_id = $value['id'];            $value['money'] = $fund[$g_id]['money'];            $value['count'] = $fund[$g_id]['count'];            $value['praise'] = $praise[$g_id]['praise'];            $value['percent'] = (($value['money']/$value['price'])*100).'%';            $value['zero2'] = strtotime ($all_goods[$key]['until_time']);            $value['tianshu'] = ceil(($value['zero2']-$zero1)/86400);            $value['days'] = '';            if ($value['tianshu']>=0) {                $value['days'] = $value['tianshu'];            }else{                 $value['days'] = 0;            }            if($value['percent']>100){                $value['percent']=100;        }            $all_goods[$key] = $value;        }//组合         foreach ($yr_goods as $key => $value) {            $g_id = $value['id'];            $value['money'] = $fund[$g_id]['money'];            $value['count'] = $fund[$g_id]['count'];            $value['praise'] = $praise[$g_id]['praise'];            $value['percent'] = (($value['money']/$value['price'])*100).'%';            $value['zero2'] = strtotime ($yr_goods[$key]['until_time']);            $value['tianshu'] = ceil(($value['zero2']-$zero1)/86400);            $value['days'] = '';            if ($value['tianshu']>=0) {                $value['days'] = $value['tianshu'];            }else{                 $value['days'] = 0;            }            if($value['percent']>100){                $value['percent']=100;        }            $yr_goods[$key] = $value;        }//组合         foreach ($in_goods as $key => $value) {            $g_id = $value['id'];            $value['money'] = $fund[$g_id]['money'];            $value['count'] = $fund[$g_id]['count'];            $value['praise'] = $praise[$g_id]['praise'];            $value['percent'] = (($value['money']/$value['price'])*100).'%';            $value['zero2'] = strtotime ($in_goods[$key]['until_time']);            $value['tianshu'] = ceil(($value['zero2']-$zero1)/86400);            $value['days'] = '';            if ($value['tianshu']>=0) {                $value['days'] = $value['tianshu'];            }else{                 $value['days'] = 0;            }            if($value['percent']>100){                $value['percent']=100;        }            $in_goods[$key] = $value;        }//组合         foreach ($end_goods as $key => $value) {            $g_id = $value['id'];            $value['money'] = $fund[$g_id]['money'];            $value['count'] = $fund[$g_id]['count'];            $value['praise'] = $praise[$g_id]['praise'];            $value['percent'] = (($value['money']/$value['price'])*100).'%';            $value['zero2'] = strtotime ($end_goods[$key]['until_time']);            $value['tianshu'] = ceil(($value['zero2']-$zero1)/86400);            $value['days'] = '';            if ($value['tianshu']>=0) {                $value['days'] = $value['tianshu'];            }else{                 $value['days'] = 0;            }            if($value['percent']>100){                $value['percent']=100;        }            $end_goods[$key] = $value;        }//组合         foreach ($allw_goods as $key => $value) {            $g_id = $value['id'];            $value['money'] = $fund[$g_id]['money'];            $value['count'] = $fund[$g_id]['count'];            $value['praise'] = $praise[$g_id]['praise'];            $value['percent'] = (($value['money']/$value['price'])*100).'%';            $value['zero2'] = strtotime ($allw_goods[$key]['until_time']);            $value['tianshu'] = ceil(($value['zero2']-$zero1)/86400);            $value['days'] = '';            if ($value['tianshu']>=0) {                $value['days'] = $value['tianshu'];            }else{                 $value['days'] = 0;            }            if($value['percent']>100){                $value['percent']=100;        }            $allw_goods[$key] = $value;        }//组合        //var_dump($g_id);exit();              $this->assign('all_goods',$all_goods);        $this->assign('allw_goods',$allw_goods);        $this->assign('yr_goods',$yr_goods);        $this->assign('in_goods',$in_goods);        $this->assign('end_goods',$end_goods);        $this->assign('hot_goods',$hot_goods);        //$this->assign('days',$days);        $this -> display(); 	}    function getWxUserInfo22() {        $user_agent = $_SERVER['HTTP_USER_AGENT'];                                    if(strpos($user_agent, 'MicroMessenger')){		if (isset($_SESSION["isLoginUser"]) && $_SESSION["isLoginUser"] === 1 && $_SESSION['isUser']) {            // echo 1;die;            if($_SESSION['user_id']!=$_GET['suid']&& isset($_GET['suid'])){                header("Location: /");            }                    $userss2=new UserModel();        $userss2=$userss2->getOne($_SESSION['user_id']);        $openid=$userss2['openid'];            $url222 = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=" . APPID . "&secret=" . APPSECRET;        $j222 = https_request($url222);        $arr222 = json_decode($j222, true);        $access_token = $arr222['access_token'];        $u222="https://api.weixin.qq.com/cgi-bin/user/info?access_token=".$access_token."&openid=".$openid."&lang=zh_CN";                $ja222 = https_request($u222);        $user = json_decode($ja222,true);        if($user['subscribe']==1 && $userss2['avatars']==''){        // echo 1;die;            $data['nickname'] = $user['nickname']?$user['nickname']:'';		$data['sex'] = $user['sex']?$user['sex']:0;		$data['city'] = $user['city']?$user['city']:'';		$data['avatars'] = $user['headimgurl']?$user['headimgurl']:'';		$data['subscribe'] = $user['subscribe']?$user['subscribe']:'';        $userss=new UserModel();                $userss->save($data,$_SESSION['user_id']);        }                }else{                                                                              if(!$_GET['code']){            //echo 1;die;            $sd=$_GET['suid'];		$url = urlencode('http://'.$_SERVER["HTTP_HOST"].'/?c=Index&suids='.$sd);         header('location: https://open.weixin.qq.com/connect/oauth2/authorize?appid=' .APPID. '&redirect_uri='.$url.'&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect');		} else {        $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=" . APPID . "&secret=" . APPSECRET . "&code={$_GET['code']}&grant_type=authorization_code";		$j = https_request($url);		$arr = json_decode($j, true);						$openid = $arr['openid'];                  		$obj = new UserModel();		$rcs = $obj -> findOne("username='" . $openid."'");                           $url222 = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=" . APPID . "&secret=" . APPSECRET;        $j222 = https_request($url222);        $arr222 = json_decode($j222, true);        $access_token = $arr222['access_token'];        $u222="https://api.weixin.qq.com/cgi-bin/user/info?access_token=".$access_token."&openid=".$openid."&lang=zh_CN";                $ja222 = https_request($u222);        $user = json_decode($ja222,true);        // print_r($user);die;        //print_r($user);die;        //echo $user222['subscribe'];die;             /*print_r($user222);die;                if($user222['subscribe']==0){            echo '未关注';die;        }else{            echo '已关注';die;        }*/ //var_dump($rcs,$user);            //die;         if($rcs){                    $subscribe = $user['subscribe']; 			$_SESSION['isLoginUser'] = $_SESSION['isUser'] = 1;			$_SESSION['account'] = $rcs['username'];			$_SESSION['username'] = $rcs['username'];			$_SESSION['nickname'] = $rcs['nickname'];			$_SESSION['user_id'] = $rcs['id'];                       if($subscribe!=0){                            			$to_url = '?c=index&suid=' . $rcs['id'];            			$this->jump($to_url);            }               return $subscribe;                            }             		if (!$openid) {			$this->error('与微信服务器通信失败，请稍后再试2！');		}        //print_r($user222['subscribe']);die;        /*if($user222['subscribe']==1){        echo "<script> if(confirm( '关注公众号？'))  location.href='http://mp.weixin.qq.com/s?__biz=MzAxODI3NjYwNg==&mid=205191451&idx=1&sn=ada1b1e643000204bde31ae91a43b93a#rd';</script>";         }*/				$user_m = new UserModel();		$data['openid'] = $user['openid'];		$data['username'] = $user['openid'];        //print_r($user);die;                /*if($user['subscribe']!=0){	    $data['nickname'] = $arr['nickname'];		$data['sex'] = $arr['sex'];		$data['city'] = $arr['city'];		$data['avatars'] = $arr['headimgurl'];        }*/	    $data['nickname'] = $user['nickname']?$user['nickname']:'';		$data['sex'] = $user['sex']?$user['sex']:0;		$data['city'] = $user['city']?$user['city']:'';		$data['avatars'] = $user['headimgurl']?$user['headimgurl']:'';		$data['subscribe'] = $user['subscribe']?$user['subscribe']:'';        $subscribe = $user['subscribe'];		//其他信息		$data['type'] = 2;		$data['last_login_time'] = time();		//$suid = get_data('suid');	//	$data['pid'] = $suid ? $suid : 0;		/*$user_m3 = new UserModel();        $uu=$user_m3->getUserByUserName($user['openid']);        if(sizeof($uu)==0){            $user_m2 = new UserModel();            $uuu=$user_m2->getCount();            $uuu[0]['count(*)']++;            $url2 = 'https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token;            $content = '欢迎你，你是我们的第'.$uuu[0]['count(*)'].'位会员。';            $openid2 = $user['openid'];            $data3 = "{\"touser\": \"{$openid2}\",\"msgtype\": \"text\",\"text\": {\"content\": \"{$content}\"}}";            $ch = curl_init();            curl_setopt($ch, CURLOPT_POST, 1);            curl_setopt($ch, CURLOPT_URL, $url2);            curl_setopt($ch, CURLOPT_POSTFIELDS, $data3);            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);            $rs2 = curl_exec($ch);            curl_close($ch);        }*/                             //print_r($data);die;  		$flag = $user_m->saveWxUser($data);                                                $rs2 = $user_m -> getOneByOpenid($openid, 'id');                                      $uid2 = $rs2['id'];                    $Fans = new FansModel();                    $data3=array();                    $data2=array();                    $fid=$Fans->getParentIdList($_GET['suids']);                    if($fid!=null){                          $data3['uid']=$uid2;                        $data3['pid']=$_GET['suids'];                        $users=new UserModel();                        $users=$users->getOne($_GET['suids']);                                                /*$user_m2 = new UserModel();                        $uuu=$user_m2->getCount();                        $uuu[0]['count(*)']++;                        $url2 = 'https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token;                        $content = '恭喜您多了个粉丝。';                        $openid2 = $users['openid'];                        $data3 = "{\"touser\": \"{$openid2}\",\"msgtype\": \"text\",\"text\": {\"content\": \"{$content}\"}}";                        $ch = curl_init();                        curl_setopt($ch, CURLOPT_POST, 1);                        curl_setopt($ch, CURLOPT_URL, $url2);                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data3);                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);                        $rs3 = curl_exec($ch);                        curl_close($ch);*/                                                                        $Fans->save($data3,'');                                                $user_m2 = new UserModel();                        $uuu=$user_m2->getCount();                        $uuu[0]['count(*)']++;                        $url2 = 'https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token;                        $content = '恭喜您多了个粉丝。';                        $openid2 = $users['openid'];                        $data3 = "{\"touser\": \"{$openid2}\",\"msgtype\": \"text\",\"text\": {\"content\": \"{$content}\"}}";                        $ch = curl_init();                        curl_setopt($ch, CURLOPT_POST, 1);                        curl_setopt($ch, CURLOPT_URL, $url2);                        curl_setopt($ch, CURLOPT_POSTFIELDS, $data3);                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);                        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);                        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);                        $rs3 = curl_exec($ch);                        curl_close($ch);                    }else{                        $data3['uid']=$uid2;                        $data3['pid']=$_GET['suids'];                        $Fans->save($data3,'');                        $data2['uid']=$_GET['suids'];                        $data2['pid']=1;                        $Fans->save($data2,'');                    }                		if ($flag) {               			$rs = $user_m->getUserByUserName($user['openid']);			$_SESSION['isLoginUser'] = $_SESSION['isUser'] = 1;			$_SESSION['account'] = $data['username'];			$_SESSION['username'] = $data['username'];			$_SESSION['nickname'] = $data['nickname'];			$_SESSION['user_id'] = $rs['id'];            if($subscribe!=0){                            			$to_url = '?c=index&suid=' . $rs['id'];            			$this->jump($to_url);            }		}       return $subscribe;		//$this->jump('?c=Index');		}        }                   }       return 1;    }	/*function getWxUserInfo() {	 if (isset($_GET['code'])) {	 $code = $_GET['code'];	 } else {	 $this->error('与微信服务器通信失败，请稍后再试1！');	 }	 $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=" . APPID . "&secret=" . APPSECRET . "&code={$code}&grant_type=authorization_code";	 $j = https_request($url);	 $arr = json_decode($j, true);	 $refresh_token = $arr['refresh_token'];	 $access_token = $arr['access_token'];	 $openid = $arr['openid'];	 if (!$openid) {	 $this->error('与微信服务器通信失败，请稍后再试2！');	 }	 $u="https://api.weixin.qq.com/sns/userinfo?access_token={$access_token}&openid={$openid}&lang=zh_CN";	 $ja = https_request($u);	 $user = json_decode($ja,true);	 $user_m = new UserModel();	 $data['openid'] = $user['openid'];	 $data['username'] = $user['openid'];	 $data['nickname'] = $user['nickname'];	 $data['sex'] = $user['sex'];	 $data['city'] = $user['city'];	 $data['avatars'] = $user['headimgurl'];	 //其他信息	 $data['type'] = 2;	 $data['last_login_time'] = time();	 $uid = get_data('uid');	 //	$data['pid'] = $uid ? $uid : 0;	 $flag = $user_m->saveWxUser($data);	 if ($flag) {	 $rs = $user_m->getUserByUserName($user['openid']);	 $_SESSION['isLoginUser'] = $_SESSION['isUser'] = 1;	 $_SESSION['account'] = $data['username'];	 $_SESSION['username'] = $data['username'];	 $_SESSION['nickname'] = $data['nickname'];	 $_SESSION['user_id'] = $rs['id'];	 $to_url = '?c=Index&uid=' . $rs['id'].'&ok=1';	 $this->jump($to_url);	 }	 $this->jump('?c=Index');	 }*/}